<% t0 <- Sys.time() %>

<%
library("PSCBS");
fixLocations <- function(fit, ...) {
  for (key in grep("(End|Start)$", colnames(fit$output))) {
    fit$output[[key]] <- as.integer(fit$output[[key]]);
  }
  fit;
} # fixLocations()

devOptions("png", width=840);
options(width=85);
options(digits=3);
options(str=strOptions(strict.width="cut"));
%>

\documentclass[letter,12pt]{article}
\usepackage{xspace}
\usepackage{alltt}
\usepackage{xcolor}
\usepackage{natbib} % \citep{}, \citet{}

\usepackage{graphicx}
\graphicspath{{figures/}}

\usepackage{hyperref} % \url{}
\hypersetup{hidelinks}

% Page margins
\addtolength{\oddsidemargin}{-0.5in}	
\addtolength{\evensidemargin}{-0.5in}	
\addtolength{\textwidth}{1in}
\addtolength{\topmargin}{-0.5in}	
\addtolength{\textheight}{1in}

% Placement of floats
\setcounter{bottomnumber}{2}
\renewcommand{\topfraction}{1.0}
\renewcommand{\bottomfraction}{1.0}
\renewcommand{\textfraction}{0.0}
\renewcommand{\floatpagefraction}{1.0}

% Macros
\newcommand{\keywords}[1]{\footnotesize{\textbf{Keywords: }#1}\xspace}
\newcommand{\pkg}[1]{\textsl{#1}\xspace}
\newcommand{\file}[1]{\textsl{#1}\xspace}
\newcommand{\code}[1]{\texttt{#1}\xspace}
\newcommand{\bs}{$\backslash$}

\newcommand{\alphaTCN}{\alpha_{\textnormal{TCN}}\xspace}
\newcommand{\alphaDH}{\alpha_{\textnormal{DH}}\xspace}
\newcommand{\LOH}{\ensuremath{\textnormal{LOH}}\xspace}
\newcommand{\AB}{\ensuremath{\textnormal{AB}}\xspace}

\newenvironment{rspVerbatim}{\vspace{-\parskip}\begin{alltt}\color{blue}}{\end{alltt}}
\newenvironment{escapeRspVerbatim}{\vspace{-\parskip}\begin{alltt}}{\end{alltt}}


\title{Paired PSCBS}
<% pkg <- Package("PSCBS"); %>
\author{<%=getAuthor(pkg)%>}
%% \date{<%=format(as.Date(getDate(pkg)), format="%B %d, %Y")%>}
\date{June 24, 2012}

\begin{document}

\maketitle
\begin{abstract}
The Paired Parent-Specific Circular Binary Segmentation (Paired PSCBS) method partitions a tumor genome into segments of constant parent-specific copy numbers (PSCNs) based on SNP DNA microarray data from a match tumor-normal pair.  The method also calls when the identified segments with run of homozygosity (ROH), segments in allelic balance (AB), segments with loss of heterozygosity (LOH), and/or segments with neutral total copy number (NTCN).
Paired PSCBS was designed to work with data from any SNP microarray technology and generation, including Affymetrix and Illumina.

This document shows how to use the \pkg{PSCBS} package to run Paired PSCBS on a tumor-normal pair.
\end{abstract}

\keywords{copy numbers, allele specific, parent specific, genomic aberrations}

\begin{center}
\emph{This vignette is distributed as part of the \pkg{PSCBS} package, which is available on CRAN (\url{http://cran.r-project.org/}).
The authors very much appreciate feedback on this document.}
\end{center}

\clearpage
\tableofcontents

\clearpage

<%-------------------------------------------------------------------
  BACKGROUND
  -------------------------------------------------------------------%>
\section{Background}
\label{secBackground}
We will here use a small example data set to illustrate how to setup the data in a format suitable for Paired PSCBS, how to identify segments, how to call them, and how to plot and export the segmentation results.
The statistical model and the algorithm behind Paired PSCBS is explained in detail in~\citet{OlshenA_etal_2011}.


<%-------------------------------------------------------------------
  EXAMPLE
  -------------------------------------------------------------------%>
\section{Preparing data to be segmented}
The Paired PSCBS~\citep{OlshenA_etal_2011} method requires tumor-normal paired parent-specific copy-number (PSCN) signals.  More precisely, it requires total copy-number (TCN) estimates for the tumor relative to the matched normal ($C_T$), allele B fractions (BAFs) for the tumor ($\beta_T$) and BAFs for the matched normal ($\beta_N$).  The genomic location of the loci in form of chromosome and physical position are also required.


\subsection{Locus-level SNP copy-number signals}
\label{secData}
In this example we will use a small example data set part of the \pkg{PSCBS} package.  It can be loaded as:
<%
fullname <- "PairedPSCBS,exData,chr01";
%>
\begin{verbatim}
<%=evalCapture({
pathname <- system.file("data-ex/PairedPSCBS,exData,chr01.Rbin", package="PSCBS")
data <- R.utils::loadObject(pathname)
str(data)
})%>
\end{verbatim}
In additional to the mandatory fields (\code{chromosome}, \code{x}, \code{CT}, \code{betaT}, and \code{betaN}), this data set also contains TCNs for normal (\code{CN}) relative to a large pool of normal samples.  The latter will not be used here.

\subsection{Dropping TCN outliers}
\label{secTCNOutliers}
There may be some outliers among the tumor TCNs.  In CBS~\citep{OlshenA_etal_2004,VenkatramanOlshen_2007}, the authors propose to drop those before segmentation, which can be done by:
\begin{verbatim}
<%=evalCapture({
data <- dropSegmentationOutliers(data)
})%>
\end{verbatim}
Dropping TCN outliers is optional.



\section{Paired PSCBS segmentation}

\subsection{Skipping centromeres and other large gaps}
\label{secGaps}
Like the CBS method, Paired PSCBS does not take the physical locations (in units of nucleotides) of the loci in to account when segmenting the data, only their relative ordering along the genome.  This means that after having ordered the loci along genome, it will treat two "neighboring" loci that are on both sides of the centromere equally as two neighboring loci that are only few hundred bases apart.  This may introduce erroneous change points that appears to be inside the centromere and biological impossible interpretation of the identified copy-number states.  The same issues occur for other large gaps of the genome where there are no observed signals.

To avoid this, although not mandatory, we will locate all gaps of the genome where there are no observered loci.  As a threshold we will consider a region to be a "gap" if the distance between the two closest loci is greater than 1Mb.
\begin{verbatim}
<%=evalCapture({
gaps <- findLargeGaps(data, minLength=1e6)
gaps
})%>
\end{verbatim}
which shows that there is a 20.5Mb long gap between 121.0Mb and 141.5Mb on Chromosome~1.  This is the centromere of Chromosome~1.
Gaps cannot be specified directly.  Instead they need to be given as part of a set of "known" segments, which is done as:
\begin{verbatim}
<%=evalCapture({
knownSegments <- gapsToSegments(gaps)
knownSegments
})%>
\end{verbatim}
Below, we will use this to tell Paired PSCBS to segment Chromosome~1 into three independent segments, where the first segment is from the beginning of the chromosome (hence '-Inf') to 120.1Mb, the second one from 120.1-141.5Mb (the above gap), and the third one is from 141.5Mb to the end of the chromosome (hence '+Inf').
Just as Paired PSCBS segments chromosomes independently of each other, it also segments priorly known segments independently of each other.
Specifying known segments is optional.


\subsection{Identifying PSCN segments}
We are now ready to segment the locus-level PSCN signals.  This is done by\footnote{We fix the random seed in order for the results of this vignette to be exactly reproducible.}:
\begin{verbatim}
<%=evalCapture({
fit <- segmentByPairedPSCBS(data, knownSegments=knownSegments, seed=0xBEEF, verbose=-10)
})%>
\end{verbatim}
Note that this may take several minutes when applied to whole-genome data.
The above call will also normalize the tumor BAFs using the TumorBoost normalization method~\citep{BengtssonH_etal_2010}.  If this has already been done or the tumor signals have been normalized by other means, the TumorBoost step can be skipped by setting argument \code{tbn=FALSE}.

The result of the segmentation is a set of segments identified to have the same underlying PSCN levels.  In this particular case, <%=nbrOfSegments(fit)%> PSCN segments were found:
<% fit <- fixLocations(fit); %>
\begin{verbatim}
<%=evalCapture({
getSegments(fit, simplify=TRUE)
})%>
\end{verbatim}
<% segs <- getSegments(fit, simplify=TRUE) %>
Note how Segment~\#<%=which(segs$tcnNbrOfLoci == 0)%> has no mean-level estimates.  It is because it corresponds to the centromere (the gap) that was identified above.  Paired PSCBS did indeed try to segment it, but since there are no data points, all estimates are missing values.
Similarly, for Segment~\#<%=which(segs$dhNbrOfLoci == 0)%> the DH and minor and major CNs mean estimates are all missing values.  This is because, Paired PSCBS identified that segment by first segmenting the TCN signals by themselves, and thereafter it tried segmenting the DH signals within that segment.  Since there are no heterozygous SNPs in the segment, there exist no DH signals, and hence no DH mean estimate.


\subsection{Displaying genomic PSCN profiles}
To plot the PSCN segmentation results, do:
\begin{verbatim}
plotTracks(fit)
\end{verbatim}
which by default displays three panels containing TCN, decrease of heterozygosity (DH), and minor and major CNs as in Figure~\ref{figTracks}.
To only plot one panel with TCN and minor and major CNs and zoom in on a particular region, do:
\begin{verbatim}
plotTracks(fit, tracks="tcn,c1,c2", xlim=c(120,244)*1e6)
\end{verbatim}
\begin{figure}[htp]
 \begin{center}
  \resizebox{0.96\textwidth}{!}{\includegraphics{<%=toPNG(fullname, tags=c("tracks"), aspectRatio=0.6, {
    plotTracks(fit);
  })%>}}
 \end{center}
 \caption{PSCN segments identified by Paired PSCBS.
  \textbf{Top}: The TCN signals (black dots) with the TCN mean levels (purple).
  \textbf{Middle}: The DH signals (black dots) with the DH mean levels (orange).
  \textbf{Bottom}: The TCN signals (black dots) with the minor CN ($C_1$; blue), the major CN ($C_2$; red) and the TCN ($C=C_1+C_2$; purple) mean levels.
 }
 \label{figTracks}
\end{figure}






\section{Calling segments}
The calling algorithms for allelic balance (AB) and loss of heterozygosity (LOH) are based on quantile estimates of the different mean levels.  These estimates are obtained from using non-parametric bootstrap techniques.  For more details, see~\citet{OlshenA_etal_2011}.
After the Paired PSCBS method was published, we have also added methods for calling run of homozygosity (ROH) and neutral total copy number (NTCN).



\subsection{Calling segments with run of homozygosity (ROH)}
A region has a run of homozygotes (ROH) if all of its SNPs are homozygous (in the normal).  Since such a region has no heterozyous SNPs, its decrease of heterozygosity (DH) is undefined.  Likewise, the minor and major copy numbers are unknown.
 However, if there are genotyping errors within an ROH region, we will obtain a non-missing DH mean level and hence also finite minor and major CNs.  In order to adjust for these faulty estimates, we test if the identified segments are ROHs or not by:
\begin{verbatim}
<%=evalCapture({
fit <- callROH(fit, verbose=-10)
})%>
\end{verbatim}
This will also set the corresponding DH and minor and major CN mean levels to NA.  The total CN mean levels are not affected by the ROH call.

\subsubsection{Tuning parameters}
For each segment, the test for ROH calculates the fraction of SNPs
that are called heterozygous.  If the fraction of heterozygotes is smaller
than a threshold, the segmented is called ROH, otherwise not.  
The default threshold is 1/12.
To use a different threshold, set argument \code{delta} to a scalar in $[0,1]$.
For example, using \code{callROH(fit, delta=1/30)} makes the ROH caller
more conservative.


\subsection{Calling segments in allelic balance (AB)}
The AB caller tests whether the DH level of a segment is small enough to be considered zero, which means that the minor and the major CNs are equal, i.e. the segment is in allelic balance.
To call the AB state of all segments, do:
\begin{verbatim}
<%=evalCapture({
fit <- callAB(fit, verbose=-10)
})%>
\end{verbatim}
Because the caller utilizes bootstrapping techniques, calling AB may take some time if there is a large number of segments.
Segments already called ROH will not be called for AB, and their AB statuses will have a missing value (\code{NA}).


\subsubsection{Tuning parameters}
The AB caller tests whether a segment's DH is zero or not, by comparing its DH level (more precisely the $5\%$ quantile of its bootstrapped DH mean level) to a threshold.  This threshold will be function of the noise level, because the noiser the BAF signals (and hence the DH signals) are, the greater the bias of the DH mean level for segments in AB will be.  Because of this, the threshold is choosen from data by estimating the noise level of the DH signals near zero.
Further rationales and details are given in~\citet{OlshenA_etal_2011}.
The AB threshold can be estimated explicitly and used in the caller as 
\begin{verbatim}
deltaAB <- estimateDeltaAB(fit, scale=1)
fit <- callAB(fit, delta=deltaAB)
\end{verbatim}
By decreasing argument \code{scale} (a positive scalar), a smaller 
threshold will be obtained resulting in a more conservative AB caller.


\subsection{Calling segments with loss of heterozygosity (LOH)}
The LOH caller tests whether the minor CN level of a segment is large enough to be considered non-zero, which means that the segment is \emph{not} in LOH.
To call the LOH state of all segments, do:
\begin{verbatim}
<%=evalCapture({
fit <- callLOH(fit, verbose=-10)
})%>
\end{verbatim}
Note that in order to call LOH, one has to call allelic balance first.  Since the bootstrapping was already done in the AB caller, it is not repeated here, which is why calling LOH is faster than calling AB.
Analogously to the AB caller, segments already called ROH will not be called for LOH, and their LOH statuses will have a missing value (\code{NA}).
Segments already called AB will be called non-LOH, because AB and LOH are exclusively mutual states.  

\subsubsection{Tuning parameters}
The LOH caller tests whether a segment's minor CN is non-zero or not, by comparing its minor CN level (more precisely the $95\%$ quantile of its bootstrapped minor CN mean level) to a threshold.  This threshold will, among other components, be function of normal contamination, i.e. the greater the fraction of normal cells is the greater the threshold needs to be in order to call LOH in the tumor cells.  Because of this, the threshold is choosen from data as the midpoint of the estimated levels of minor CNs zero and one, which in turn is a function of the normal contamination.  For details on the definition of LOH and details on the LOH caller, see~\citet{OlshenA_etal_2011}.
The LOH threshold can be estimated explicitly and used as:
\begin{verbatim}
deltaLOH <- estimateDeltaLOH(fit, midpoint=1/2)
fit <- callLOH(fit, delta=deltaLOH)
\end{verbatim}
By decreasing argument \code{midpoint} in $[0,1]$, a smaller 
threshold will be obtained resulting in a more conservative LOH caller.



\subsection{Calling segments with neutral total copy number (NTCN)}
The neutral total copy number (NTCN) caller tests whether the total CN level of a segment is neutral (e.g. diploid) or not.
To call the NTCN state of all segments, do:
\begin{verbatim}
<%=evalCapture({
fit <- callNTCN(fit, verbose=-10)
})%>
\end{verbatim}


\subsubsection{Tuning parameters}
The NTCN caller identifies segments which TCN mean levels (more precisely the $95\%$ confidence interval) are within a given "acceptance" region.  This acceptance region is determined by the $95\%$ confidence interval of an initial set of AB segments identified to be copy neutral and then expanded by half a TCN unit length.  The true length of half a total copy number unit is a function of the normal contamination and specified by argument \code{deltaCN} to \code{callCN()}.  The greater the normal contamination, the smaller \code{deltaCN} should be such that the width of the acceptance region becomes smaller.  Argument \code{deltaCN} can be estimated explicitly as:
\begin{verbatim}
deltaCN <- estimateDeltaCN(fit, scale=1)
fit <- callNTCN(fit, delta=deltaCN, verbose=-10)
\end{verbatim}
By decreasing argument \code{scale} (a positive scalar), a smaller acceptance region will
be obtained resulting in a more conservative CN caller.



\subsection{Results from calling ROH, AB, LOH and NTCN}
All calls are appended to the segmentation results as logical columns:
\begin{verbatim}
<%=evalCapture({
getSegments(fit, simplify=TRUE)
})%>
\end{verbatim}
<% segs <- getSegments(fit, simplify=TRUE) %>


\section{Saving results}

\subsection{Writing segments to a tab-delimited text file}
To write the PSCN segmentation results to file, do:
\begin{verbatim}
pathname <- writeSegments(fit, name="MySample", simplify=TRUE)
\end{verbatim}



\section{Experimental}
In this section we illustrate some of the ongoing and future work of the PSCBS package.  Please be aware that these methods are very much under construction, possibly incomplete and in worst case even incorrect.

\subsection{Report generation}
A multipage PDF report that contains both whole-genome and per-chromosome summaries and figures can be generated by:
\begin{verbatim}
> report(fit, sampleName="PairedPSCBS", studyName="PSCBS-Ex", verbose=-10)
\end{verbatim}
By default, the reports are written to directory \code{reports/<studyName>/} under the current working directory.  In addition to the PDF, that directory also contains subdirectory \code{figures/} holding all generated figure files (e.g. PNGs and PDFs) for easy inclusing elsewhere.


\subsection{Pruning segmentation profile}
By using hierarchical cluster of the segment means it is possible to prune the PSCN profile such that change points with very small absolute changes are dropped.  If change points are dropped this way, this results in a smaller number of segments, which are hence longer on average.
\begin{verbatim}
<%=evalCapture({
fitP <- pruneByHClust(fit, h=0.25, verbose=-10)
})%>
\end{verbatim}
\begin{figure}[htp]
 \begin{center}
  \resizebox{0.96\textwidth}{!}{\includegraphics{<%=toPNG(fullname, tags=c("pruned", "tracks"), aspectRatio=0.6, {
    plotTracks(fitP);
  })%>}}
 \end{center}
 \caption{Pruned PSCN segments plotted as in Figure~\ref{figTracks}.}
 \label{figTracksPruned}
\end{figure}




<%-------------------------------------------------------------------
  REFERENCES
  -------------------------------------------------------------------%>
\bibliographystyle{natbib}
\bibliography{PSCBS}


<%-------------------------------------------------------------------
  APPENDIX
  -------------------------------------------------------------------%>
\clearpage
\section*{Appendix}
\subsection*{Session information}
<%=toLatex(sessionInfo())%>
This report was automatically generated using \code{rsp()} of the R.rsp package.
Total processing time after RSP-to-R translation was <%=dt <- round(Sys.time()-t0, digits=2)%> <%=attr(dt, "units")%>.

\end{document}
