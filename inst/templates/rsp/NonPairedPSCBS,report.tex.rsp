%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Authors: Henrik Bengtsson
% Created on: 2013-03-08
% Last updated: See HISTORY below.
%
% Usage:
%  R.rsp::rfile("PairedPSCBS.tex.rsp", workdir="reports,rsp/");
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
<%
library("PSCBS");
library("R.cache");
getChecksum <- R.cache::getChecksum;
stopifnot(exists("rspArgs", mode="list"));
%>

<%--------------------------------------------------------------------
Include R code
--------------------------------------------------------------------%>
<%
<%@include file="assignIfMissing.R"%>
%>

<%--------------------------------------------------------------------
Include RSP templates
--------------------------------------------------------------------%>
<%@include file="reportHeader.tex.rsp"%>


<%--------------------------------------------------------------------
Report configuration
--------------------------------------------------------------------%>
<%@define PERCHROMOSOME="${PSCBS::reports/perChromosome}" default="TRUE"%>
<%@define DENSITIES="${PSCBS::reports/densities}" default="TRUE"%>
<%@define C1C2="${PSCBS::reports/pscnSegmentationTransitions}" default="TRUE"%>

<%-- Used? --%>
<%@define USEALPHACHANNEL="${PSCBS::reports/useAlphaChannel}" default="TRUE"%>

<%-- To implement --%>
<%@define PERGENOTYPE="${PSCBS::reports/perGenotype}" default="TRUE"%>


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% LATEX STARTUP
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[twoside,12pt]{article}
\usepackage{fancyvrb} % Custom verbose environments
\usepackage{lastpage} % Total number of pages
\usepackage{xspace}
\usepackage{subfigure}  % \subfigure[<title>]{}
\usepackage[round]{natbib}

% No paragraph indentation
\setlength{\parindent}{0cm}

\addtolength{\oddsidemargin}{-0.4in}
\addtolength{\evensidemargin}{-1.02in}
\addtolength{\textwidth}{1.5in}
\addtolength{\topmargin}{-1.0in}
\addtolength{\textheight}{1.5in}

\renewcommand{\topfraction}{1.00}   % max fraction of floats at top
\renewcommand{\bottomfraction}{1.0} % max fraction of floats at bottom
\renewcommand{\textfraction}{0.00}


\newcommand{\code}[1]{\texttt{#1}\xspace}

\newcommand{\TCN}{TCN\xspace}
\newcommand{\BAF}{\BAF\xspace}
\newcommand{\BAFN}{BAF$_{N}$\xspace}
\newcommand{\BAFT}{BAF$_{T}$\xspace}
\newcommand{\BAFTN}{BAF$^*_{T}$\xspace}


<% pairedPSCBSReport <- function(fit, sampleName=NULL, dataSet=NULL, studyName=NULL, Clim=c(0,4), Blim=c(0,1), reportPath=file.path("reports", studyName), figPath=file.path(reportPath, "figures"), ..., figForce=FALSE) { %>

<%@ifeq DENSITIES="TRUE"%>
 <%@include file="signalDensities.tex.rsp"%>
<%@endif%>
<%@include file="summaryOfAnnotationAndGenotypeCalls.tex.rsp"%>
<%@include file="pscnSegmentationTracks.tex.rsp"%>
<%@include file="pscnSegmentationTransitions.tex.rsp"%>

<%
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Validate arguments
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Argument 'fit':
fit <- Arguments$getInstanceOf(fit, "PairedPSCBS");
fitClass <- class(fit)[1L];
if (inherits(fit, "NonPairedPSCBS")) {
  fitClassLbl <- "Non-paired PSCBS";
} else if (inherits(fit, "PairedPSCBS")) {
  fitClassLbl <- "Paired PSCBS";
} else if (inherits(fit, "CBS")) {
  fitClassLbl <- "CBS";
} else {
  fitClassLbl <- fitClass;
}

# Argument 'sampleName':
if (is.null(sampleName)) {
  sampleName <- sampleName(fit);
}
sampleName <- Arguments$getCharacter(sampleName);
sampleNameEscDots <- gsub(".", "_", sampleName, fixed=TRUE);

# Argument 'dataSet':
if (!is.null(dataSet)) {
  dataSet <- Arguments$getCharacter(dataSet);
} else {
  dataSet <- "?";
}
dataSetLbl <- sprintf("Data set: %s\\\\", toLatex(dataSet));

# Argument 'studyName':
if (is.null(studyName)) studyName <- fitClassLbl;
studyName <- Arguments$getCharacter(studyName);
studyLbl <- sprintf("Study: %s\\\\", toLatex(studyName));

# Argument 'reportPath':
reportPath <- Arguments$getWritablePath(reportPath);

# Argument 'figPath':
figPath <- Arguments$getWritablePath(figPath);

# Argument 'figForce':
figForce <- Arguments$getLogical(figForce);
%>

<%
oFigPath <- setOption("devEval/args/path", figPath);
on.exit({
  setOption("devEval/args/path", oFigPath);
}, add=TRUE);

oPar <- setOption("devNew/args/par", list(lwd=2));
on.exit({
  setOption("devNew/args/par", oPar);
}, add=TRUE);
%>

<%reportHeaderSetup(fit, sampleName=sampleName, dataSet=dataSet, studyName=studyName) %>
<%reportHeaderUpdate(fit)%>


% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
% GRAPHICS SETTINGS
% - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
<%
setOption("devEval/args/force", figForce);
%>
\usepackage{graphicx}
\graphicspath{{<%=figPath%>/} {../<%=figPath%>/}} 

<%
ClimX <- Clim + c(-1,1)*diff(Clim)*0.08;
BlimX <- Blim + c(-1,1)*diff(Blim)*0.08;

%>
<%-- Setup of constants etc used in graphics --%>
<@include file="reportSetupGraphics.R"%>

\begin{document}
\title{<%=fitClassLbl%> Report:\\<%=studyLbl%><%=dataSetLbl%>Sample: <%=toLatex(sampleName)%>}
\author{Report template by Henrik Bengtsson}
\maketitle
\thispagestyle{fancy}

%%\tableofcontents

%>
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% DATA
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% METHODS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}
\label{sec:Introduction}
This is a quality control (QC) report based on non-paired tumor SNP microarray data.

\subsection{Method}
\label{sec:Method}
We use a non-paired PSCBS segmentation method to partion the genome into segments such that all signals in a particular segment are likely to originate from the same underlying parent-specific copy-number state.  This method is adopted from the Paired PSCBS segmentation method~\citep{OlshenA_etal_2011} with two main differences.
First, heterozygous SNPs are "called" based on tumor allele B fractions ("tumor BAFs"), which are poor proxies for the corresponding normal ones.  This is a major disadvantage compared to having a matched normal.
Second, the tumor BAFs cannot be normalized using the TumorBoost method~\citep{BengtssonH_etal_2010}.  


<%--
\subsection{Post-segmentation pruning}
\label{sec:PostSegmentationPruning}
<%
fitP <- pruneByHClust(fit, h=0.25);
#print(fitP);
%>
--%>

\clearpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% RESULTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
% WHOLE-GENOME RESULTS
% = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
\section{Whole-Genome Results}
\label{ch:WholeGenomeResults}

<%=summaryOfAnnotationAndGenotypeCalls(fit)%>
<%@ifeq DENSITIES="TRUE"%>
<%=signalDensities(fit, fields=c("CT", "betaT", "rho", "c1", "c2"))%>
<%@endif%>
<%=pscnSegmentationTracks(fit)%>
<%@ifeq C1C2="TRUE"%>
<%=pscnSegmentationTransitions(fit)%>
<%@endif%>


% = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
% PER CHROMOSOME SEGMENTATION
% = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
<%@ifeq PERCHROMOSOME="TRUE"%>
<% if (nbrOfChromosomes(fit) > 1) { %>
<% for (chr in getChromosomes(fit)) { %>
<%
fitT <- extractChromosome(fit, chromosome=chr);
%>
\clearpage
\section{Chromosome <%=chr%>}
\label{sec:Chromosome<%=chr%>Results}
<%reportHeaderUpdate(fit)%>
<%=summaryOfAnnotationAndGenotypeCalls(fitT)%>
<%@ifeq DENSITIES="TRUE"%>
<%=signalDensities(fitT, fields=c("CT", "betaT", "rho", "c1", "c2"))%>
<%@endif%>
<%=pscnSegmentationTracks(fitT)%>
<%@ifeq C1C2="TRUE"%>
<%=pscnSegmentationTransitions(fitT)%>
<%@endif%>
<% } # for (chr ...) %>
<% } # if (REPORT_PER_CHROMOSOME && nbrOfChromosomes(fit) > 1) %>
<%@endif # PERCHROMOSOME %>

<%--
% = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
% PRUNED: WHOLE-GENOME SEGMENTATION
% = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
\subsection{Hierarchical pruning}
\label{sec:HierarchicalPruning}

% = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
% PRUNED: PER CHROMOSOME SEGMENTATION
% = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =
--%>


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% REFERENCES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\bibliography{bioinformatics-journals-abbr,PSCBS}
%\bibliographystyle{plain}
\bibliographystyle{natbib}

\appendix
\section{Appendix}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Session information
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \clearpage
\section*{Session information}
<%=toLatex(sessionInfo())%>
This report was generated via \code{report(fit)} which utilizes the R.rsp package.  The template for this report was created by Henrik Bengtsson and last updated on March 12, 2012.
\end{document}

<% } # pairedPSCBSReport() %>

<%=do.call("pairedPSCBSReport", args=rspArgs)%>



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% HISTORY:
# 2012-11-03
# o Replaced deprecated ggplot2 functions.
# 2012-09-16
# o Added easy report configuration at the very top.
# 2012-05-30
# o Removed ggplot2 warnings on missing values.
# 2012-02-28
# o Now it is possible to turn off usage of the alpha channel in
#   plots, e.g. setOption("PSCBS::report/useAlphaChannel", FALSE).
#   This is useful for if the alpha channel is not supported.
% 2012-02-27
% o First successful run with real data.
% o Now all of the report uses a PairedPSCBS object.
% o Now making more use of templates.
% o Now passing a data frame to segmentByPairedCBS().
% 2011-09-30
% o Created.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
